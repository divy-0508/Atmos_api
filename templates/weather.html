{% extends "base.html" %}
{% block title %}Weather — AtmosAPI{% endblock %}

{% block content %}
<div class="weather-page">
  <div class="weather-panel card p-4 shadow">
    <h3 class="mb-2">Weather — {{ weather.city }}, {{ weather.country }}</h3>
    <p class="mb-1 text-muted">{{ weather.description }}</p>

    <!-- animated gauge -->
    <div class="gauge-wrap my-3">
      <svg viewBox="0 0 120 120" class="gauge-svg" id="gaugeSvg">
        <defs>
          <linearGradient id="ggrad" x1="0" x2="1">
            <stop offset="0%" stop-color="#6ad" />
            <stop offset="100%" stop-color="#0b84ff" />
          </linearGradient>
        </defs>

        <circle cx="60" cy="60" r="44" class="gauge-bg"></circle>
        <circle cx="60" cy="60" r="44" class="gauge-fill" id="gaugeFill"
                stroke="url(#ggrad)" stroke-linecap="round"
                stroke-dasharray="276 999" stroke-dashoffset="276" transform="rotate(-90 60 60)"></circle>
        <text x="60" y="66" text-anchor="middle" class="gauge-text" id="gaugeText">{{ prediction }}%</text>
      </svg>
    </div>

    <!-- details -->
    <div class="details text-center mb-3">
      <div><strong>Time:</strong> {{ time or '—' }}</div>
      <div><strong>Temp:</strong> {{ weather.temperature }} °C (feels {{ weather.feels_like }} °C)</div>
      <div><strong>Humidity:</strong> {{ weather.humidity }}%</div>
      <div><strong>Wind:</strong> {{ weather.wind_speed }} m/s</div>
      <div><strong>Pressure:</strong> {{ weather.pressure }} hPa</div>
    </div>

    <!-- actions: Listen, Comfort Score, Try another -->
    <div class="d-flex justify-content-center gap-2">
      <button id="speakBtn" class="btn btn-success"><i class="fas fa-volume-up"></i> Listen</button>

      <a id="comfortBtn" class="btn btn-warning" role="button"
         href="{{ url_for('comfort_score') }}?city={{ weather.city|urlencode }}&temperature={{ weather.temperature }}&humidity={{ weather.humidity }}&rain={{ prediction }}&time={{ time or '' }}">
        <i class="fas fa-star"></i> Comfort Score
      </a>

      <a class="btn btn-outline-primary" href="{{ url_for('index') }}"><i class="fas fa-home"></i> Try another</a>
    </div>

    <p class="mt-3 text-center text-muted small">{{ recommendation }}</p>
  </div>
</div>

{% block scripts %}
<script>
  // Animate gauge on load
  document.addEventListener("DOMContentLoaded", () => {
    const fill = document.getElementById("gaugeFill");
    const txt = document.getElementById("gaugeText");
    const prediction = Number("{{ prediction }}") || 0;
    const radius = 44;
    const circumference = 2 * Math.PI * radius; // ~276.46

    // set base dasharray
    fill.style.strokeDasharray = `${Math.round(circumference)} 999`;
    // starting offset (empty)
    fill.style.strokeDashoffset = Math.round(circumference);

    // animate to target
    const targetOffset = Math.round(circumference - (circumference * prediction / 100));
    // animate using requestAnimationFrame
    let current = circumference;
    const step = (current - targetOffset) / 60; // ~60 frames
    function animate() {
      current = Math.max(targetOffset, current - step);
      fill.style.strokeDashoffset = Math.round(current);
      if (current > targetOffset) {
        requestAnimationFrame(animate);
      }
    }
    requestAnimationFrame(animate);

    // speak button
    const speakBtn = document.getElementById("speakBtn");
    speakBtn.addEventListener("click", () => {
      const text = `Weather in {{ weather.city }}: {{ weather.description }}. Temperature ${'{{ weather.temperature }}'} degrees Celsius. Rain chance ${'{{ prediction }}'} percent.`;
      speakText(text);
    });
  });
</script>
{% endblock %}
{% endblock %}
